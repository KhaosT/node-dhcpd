sprintf = require('./../support/sprintf')
converters = require('./converters')
utils = require('./utils')

extractChaddr = (b) -> 
  [f, len, reg] = ["%02x", b[2], []]
  bytes = b.slice(28, 28+len)
  (sprintf(f, octet) for byte in bytes).join ':'

fromBuffer = (b) ->
  ret =
    op: b[0]
    htype: b[1]
    hlen: b[2]
    hops: b[3]
    xid: utils.readInt32(b, 4) # b[4] + b[5] + b[6] + b[7];
    secs: utils.readInt16(b, 8) # b[8] + b[9];
    flags: utils.readInt16(b, 10) # b[10] + b[11];
    ciaddr: sprintf('%d.%d.%d.%d', b[12], b[13], b[14], b[15])
    yiaddr: sprintf('%d.%d.%d.%d', b[16], b[17], b[18], b[19])
    siaddr: sprintf('%d.%d.%d.%d', b[20], b[21], b[22], b[23])
    giaddr: sprintf('%d.%d.%d.%d', b[24], b[25], b[26], b[27])
    chaddr: extractChaddr(b)
    sname: ''

  ret.sname = (s for b in b.slice 44, 44+64).join ''
  ret.file = (s for b in b.slice 108, 236).join ''

  [i, options] = [0, b.slice(240)]
  while i < options.length and options[i] != 255
    optNum = parseInt options[i++], 10
    optLen = parseInt options[i++], 10
    optVal = converters(opt).decode(options.slice(i, i+optLen))
    ret.options[optNum] = optVal
    i += optLen

  ret

toBuffer = (data) ->
  array = []; i = 0
  array[i++] = @op
  array[i++] = @htype
  array[i++] = @hlen
  array[i++] = @hops

  utils.writeInt32(array, @xid, pos); pos += 4;
  utils.writeInt16(array, @secs, pos); pos += 2;
  utils.writeInt16(array, @flags, pos); pos += 2;

  array[i++] = parseInt(octet, 10) for octet in @ciaddr.split('.')
  array[i++] = parseInt(octet, 10) for octet in @yiaddr.split('.')
  array[i++] = parseInt(octet, 10) for octet in @siaddr.split('.')
  array[i++] = parseInt(octet, 10) for octet in @giaddr.split('.')

  array[i++] = parseInt(octet, 16) for octet in data.chaddr.split(':')

  # filling bootp range with zeros
  array[i++] = 0 while i < 236

  # magic cookie
  array[i++] = 99
  array[i++] = 130
  array[i++] = 83
  array[i++] = 99

  # dhcp options start at byte offset 240
  i = 240
  for optNum of data.options
    optVal = data.options[optNum]
    i = converters(optNum).encode(array, optNum, optVal, i)

  # close the packet
  array[i] = 255

  new Buffer(array, 'ascii')

class Packet
  @fromBuffer: fromBuffer
  toBuffer: toBuffer
  op:       (@op)     -> this
  htype:    (@htype)  -> this
  hlen:     (@hlen)   -> this
  hops:     (@hops)   -> this
  xid:      (@xid)    -> this
  secs:     (@secs)   -> this
  flags:    (@flags)  -> this
  ciaddr:   (@ciaddr = '0.0.0.0') -> this
  yiaddr:   (@yiaddr = '0.0.0.0') -> this
  siaddr:   (@siaddr = '0.0.0.0') -> this
  giaddr:   (@giaddr = '0.0.0.0') -> this
  chaddr:   (@chaddr) -> this
  sname:    (@sname)  -> this

module.exports =
  Packet: Packet
  fromBuffer: fromBuffer
  toBuffer: toBuffer

