sprintf = require('./../support/sprintf')
optionDecoders = require('./option_decoders')
optionEncoders = require('./option_encoders')
converters = require('./converters')
utils = require('./utils')

DHCP = 
  options: require('./packet/options')
  message_types: require('./packet/types')
    

extractChaddr = (b) -> 
  [f, len, reg] = ["%02x", b[2], []]
  bytes = b.slice(28, 28+len)
  ret.push sprintf(f, octet) for byte in bytes
  ret.join ':'

fromBuffer = (b) ->
  ret =
    op: b[0]
    htype: b[1]
    hlen: b[2]
    hops: b[3]
    xid: utils.readInt32(b, 4) # b[4] + b[5] + b[6] + b[7];
    secs: utils.readInt16(b, 8) # b[8] + b[9];
    flags: utils.readInt16(b, 10) # b[10] + b[11];
    ciaddr: sprintf('%d.%d.%d.%d', b[12], b[13], b[14], b[15])
    yiaddr: sprintf('%d.%d.%d.%d', b[16], b[17], b[18], b[19])
    siaddr: sprintf('%d.%d.%d.%d', b[20], b[21], b[22], b[23])
    giaddr: sprintf('%d.%d.%d.%d', b[24], b[25], b[26], b[27])
    chaddr: extractChaddr(b)
    sname: '';

  ret.sname = (s for b in b.slice 44, 44+64).join ''
  ret.file = (s for b in b.slice 108, 236).join ''

  [i, options] = [0, b.slice(240)]
  while i < options.length and options[i] != 255
    optNum = parseInt options[i++], 10
    optLen = parseInt options[i++], 10
    optVal = converters(opt).decode(options.slice(i, i+optLen))
    ret.options[optNum] = optVal
    i += optLen

  ret

class Packet
  @fromBuffer: fromBuffer
  op: (@op) ->
  htype: (@htype) ->
  hlen: (@hlen) ->
  hops: (@hops) ->
  xid: (@xid) ->
  secs: (@secs) ->
  flags: (@flags) ->
  ciaddr: (@ciaddr) ->
  yiaddr: (@yiaddr) ->
  siaddr: (@siaddr) ->
  giaddr: (@giaddr) ->
  chaddr: (@chaddr) ->
  sname: (@sname) ->
  toBuffer: (data) ->
    array = []; i = 0
    array[i++] = @op
    array[i++] = @htype
    array[i++] = @hlen
    array[i++] = @hops

    ciaddr = data.ciaddr || '0.0.0.0'
    yiaddr = data.yiaddr || '0.0.0.0'
    siaddr = data.siaddr || '0.0.0.0'
    giaddr = data.giaddr || '0.0.0.0'
    array[i++] = parseInt(octet, 10) for octet in ciaddr.split('.')
    array[i++] = parseInt(octet, 10) for octet in yiaddr.split('.')
    array[i++] = parseInt(octet, 10) for octet in siaddr.split('.')
    array[i++] = parseInt(octet, 10) for octet in giaddr.split('.')

    array[i++] = parseInt(octet, 16) for octet in data.chaddr.split(':')

    array[i++] = 0 while i < 236

    # magic cookie
    array[i++] = 99
    array[i++] = 130
    array[i++] = 83
    array[i++] = 99

    # dhcp options start at byte offset 240
    i = 240
    for optNum of data.options
      optVal = data.options[optNum]
      i = converters(optNum).encode(array, optNum, optVal, i)

    # close the packet
    array[i] = 255

    new Buffer(array, 'ascii')

module.exports = Packet
